<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DivePlan Tables</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
        background: linear-gradient(135deg, #f0f4f8, #fff, #f0f4f8);
        color: #333;
      }
      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        margin-bottom: 30px;
      }
      h1 {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
      }
      .subtitle {
        color: #6b7280;
      }
      .back-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 20px;
        font-size: 14px;
      }
      .back-btn:hover {
        background: #2563eb;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
      }
      .card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 18px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .card:hover {
        border-color: #3b82f6;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .card h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
      }
      .card p {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 8px;
      }
      .card .tag {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .tag-blue {
        background: #dbeafe;
        color: #1e40af;
      }
      .tag-cyan {
        background: #cffafe;
        color: #0e7490;
      }
      .tag-orange {
        background: #fed7aa;
        color: #92400e;
      }
      .tag-yellow {
        background: #fef08a;
        color: #854d0e;
      }
      .tag-green {
        background: #dcfce7;
        color: #166534;
      }
      .tag-indigo {
        background: #e0e7ff;
        color: #312e81;
      }
      .section {
        background: white;
        border-radius: 8px;
        padding: 18px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
      }
      .section h2 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
      }
      .section p {
        font-size: 13px;
        color: #6b7280;
      }
      .depths-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 10px;
        margin-top: 16px;
      }
      .depth-btn {
        padding: 10px 8px;
        border: 2px solid #3b82f6;
        background: white;
        color: #3b82f6;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s;
      }
      .depth-btn:hover {
        background: #eff6ff;
      }
      .table-wrapper {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .table-header {
        background: linear-gradient(to bottom, #1d4ed8, #1e40af);
        color: white;
        padding: 16px;
        margin-bottom: 0;
      }
      .table-header h2 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 2px;
      }
      .table-header p {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.9);
        margin: 0;
      }
      .table-scroll {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      thead {
        background: linear-gradient(to bottom, #1d4ed8, #1e40af);
        color: white;
        position: sticky;
        top: 0;
      }
      th {
        padding: 8px 4px;
        text-align: center;
        border: 1px solid #0d47a1;
        font-weight: 600;
        font-size: 10px;
        line-height: 1.2;
      }
      td {
        padding: 8px 4px;
        text-align: center;
        border: 1px solid #e5e7eb;
      }
      .row-white {
        background: white;
      }
      .row-white:hover {
        background: #eff6ff;
      }
      .row-green {
        background: #f0fdf4;
      }
      .row-green:hover {
        background: #dcfce7;
      }
      .row-red {
        background: #fef2f2;
      }
      .row-red:hover {
        background: #fee2e2;
      }
      .col-blue {
        background: #eff6ff;
      }
      .error {
        background: #fee2e2;
        color: #991b1b;
        padding: 12px;
        border-radius: 6px;
        margin: 16px 0;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #6b7280;
      }
      footer {
        text-align: center;
        padding: 20px;
        color: #9ca3af;
        font-size: 11px;
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Dive Tables</h1>
        <p class="subtitle">Browse decompression tables</p>
      </header>
      <div id="content"></div>
      <footer>DivePlan Tables Widget | Offline ready</footer>
    </div>

    <script>
      const app = {
        headers: {
          SIL15: {
            title: "SIL15 - Standard Air, Repetitive Interval 12 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24", "21", "18", "15", "12", "9", "6", "3"],
            numStops: 8,
          },
          H2SIL15: {
            title: "H2SIL15 - Standard Air, Repetitive Interval 2 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24", "21", "18", "15", "12", "9", "6", "3"],
            numStops: 8,
          },
          H4SIL15: {
            title: "H4SIL15 - Standard Air, Repetitive Interval 4 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24", "21", "18", "15", "12", "9", "6", "3"],
            numStops: 8,
          },
          SOX15: {
            title: "SOX15 - Surface Decompression with Oxygen, Repetitive Interval 12 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "In Water Stops", "Stops in Deco", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols1: ["21 air", "18 air", "15 air", "12 air", "9 air", "12 ox"],
            stopCols2: ["9 air", "9 ox", "6 air", "6 ox", "3 air", "3 ox"],
            numStops: 12,
          },
          HSOX15: {
            title: "HSOX15 - Surface Decompression with Oxygen, Repetitive Interval 4 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "In Water Stops", "Stops in Deco", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols1: ["21 air", "18 air", "15 air", "12 air", "9 air", "12 ox"],
            stopCols2: ["9 air", "9 ox", "6 air", "6 ox", "3 air", "3 ox"],
            numStops: 12,
          },
          SAB15: {
            title: "SAB15 - Backup Air, Repetitive Interval 12 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "In Water Stops", "Stops in Deco", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols1: ["21", "18", "15", "12", "9", "18"],
            stopCols2: ["15", "12", "9", "6", "3"],
            numStops: 11,
          },
          HSAB15: {
            title: "HSAB15 - Backup Air, Repetitive Interval 4 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "In Water Stops", "Stops in Deco", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols1: ["21", "18", "15", "12", "9", "18"],
            stopCols2: ["15", "12", "9", "6", "3"],
            numStops: 11,
          },
          NIA15: {
            title: "NIA15 - Nitrox 40/60, Repetitive Interval 12 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24", "21", "18", "15", "12", "9", "6", "3"],
            numStops: 8,
          },
          H2NIA15: {
            title: "H2NIA15 - Nitrox 40/60, Repetitive Interval 2 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24", "21", "18", "15", "12", "9", "6", "3"],
            numStops: 8,
          },
          H4NIA15: {
            title: "H4NIA15 - Nitrox 40/60, Repetitive Interval 4 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24", "21", "18", "15", "12", "9", "6", "3"],
            numStops: 8,
          },
          NIB15: {
            title: "NIB15 - Nitrox 35/65, Repetitive Interval 12 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24", "21", "18", "15", "12", "9", "6", "3"],
            numStops: 8,
          },
          H2NIB15: {
            title: "H2NIB15 - Nitrox 35/65, Repetitive Interval 2 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24", "21", "18", "15", "12", "9", "6", "3"],
            numStops: 8,
          },
          H4NIB15: {
            title: "H4NIB15 - Nitrox 35/65, Repetitive Interval 4 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24", "21", "18", "15", "12", "9", "6", "3"],
            numStops: 8,
          },
          BOX15: {
            title: "BOX15 - Wet or Dry Bell Air/Oxygen Tables, Repetitive Interval 12 Hours",
            mainCols: ["Dive Time (min)", "Till 1st Stop", "Stop Depth (metres)", "Tot. Deco (min)", "OTU", "ESOT"],
            stopCols: ["24 air", "21 air", "18 air", "15 air", "12 air", "9 ox", "6 air", "6 ox", "6 air", "6 ox", "6 air", "6 ox"],
            numStops: 12,
          },
        },

        groups: [
          {
            name: "No-Stop Limits",
            tag: "tag-blue",
            tables: [
              { name: "Air", code: "ND15", depths: [], isReference: true },
              { name: "Air Extended", code: "LND15", depths: [], isReference: true },
            ],
          },
          {
            name: "Standard Air",
            tag: "tag-cyan",
            tables: [
              { name: "12 Hour SI", code: "SIL15", depths: [12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51] },
              { name: "2 Hour SI", code: "H2SIL15", depths: [12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51] },
              { name: "4 Hour SI", code: "H4SIL15", depths: [12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51] },
            ],
          },
          {
            name: "Surface O2",
            tag: "tag-orange",
            tables: [
              { name: "12 Hour SI", code: "SOX15", depths: [12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51] },
              { name: "4 Hour SI", code: "HSOX15", depths: [12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51] },
            ],
          },
          {
            name: "Backup Air",
            tag: "tag-yellow",
            tables: [
              { name: "12 Hour SI", code: "SAB15", depths: [12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51] },
              { name: "4 Hour SI", code: "HSAB15", depths: [12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51] },
            ],
          },
          {
            name: "Nitrox",
            tag: "tag-green",
            tables: [
              { name: "NIA 40% 12h", code: "NIA15", depths: [18, 21, 24, 27] },
              { name: "NIA 40% 2h", code: "H2NIA15", depths: [18, 21, 24, 27] },
              { name: "NIA 40% 4h", code: "H4NIA15", depths: [18, 21, 24, 27] },
              { name: "NIB 35% 12h", code: "NIB15", depths: [18, 21, 24, 27, 30, 33] },
              { name: "NIB 35% 2h", code: "H2NIB15", depths: [18, 21, 24, 27, 30, 33] },
              { name: "NIB 35% 4h", code: "H4NIB15", depths: [18, 21, 24, 27, 30, 33] },
            ],
          },
          {
            name: "Box Air/O2",
            tag: "tag-indigo",
            tables: [
              { name: "Wet/Dry Bell", code: "BOX15", depths: [12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51] },
            ],
          },
        ],

        csvCache: {},

        async loadCSV(code) {
          if (this.csvCache[code]) return this.csvCache[code];
          try {
            const response = await fetch(`/data/tables/${code}.csv`);
            if (!response.ok) return null;
            const text = await response.text();
            this.csvCache[code] = text;
            return text;
          } catch (e) {
            console.error("CSV load error:", e);
            return null;
          }
        },

        parseReferenceTableCSV(text) {
          const lines = text.trim().split("\n");
          if (lines.length < 2) return [];
          const rows = [];
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const values = line.split(",").map((v) => v.trim());
            if (values.length < 3) continue;
            const depth = parseInt(values[0]);
            if (isNaN(depth)) continue;
            const col1 = values[1] === "" ? null : parseInt(values[1]);
            const col2 = values[2] === "" ? null : parseInt(values[2]);
            rows.push({ depth, col1, col2 });
          }
          return rows;
        },

        parseSIL15CSV(text, targetDepth) {
          const lines = text.trim().split("\n");
          if (lines.length < 2) return { rows: [], dvis5: null };
          const headers = lines[0].split(",").map((h) => h.trim().toLowerCase());
          const depthIdx = 1;
          const timeIdx = 2;
          const tillIdx = 3;
          const stopStart = 4;
          const stopEnd = 12;
          const decoIdx = 12;
          const otuIdx = 13;
          const esotIdx = 14;
          const dvisIdx = 0;
          const rows = [];
          let dvis5 = null;
          let foundFirst = false;
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const cols = line.split(",").map((v) => v.trim());
            const depth = parseInt(cols[depthIdx]);
            if (isNaN(depth) || depth !== targetDepth) continue;
            if (!foundFirst) {
              const dvisVal = parseInt(cols[dvisIdx]);
              if (!isNaN(dvisVal)) dvis5 = dvisVal;
              foundFirst = true;
            }
            const time = parseInt(cols[timeIdx]);
            if (isNaN(time)) continue;
            const stops = [];
            for (let j = stopStart; j < stopEnd && j < cols.length; j++) {
              const val = cols[j];
              if (val === "") stops.push(null);
              else {
                const num = parseInt(val);
                stops.push(isNaN(num) ? null : num);
              }
            }
            let marker = 0;
            if (cols.length > 15) {
              const markerVal = parseInt(cols[15]);
              if (markerVal === 2 || markerVal === 3) marker = markerVal;
            }
            rows.push({
              time,
              till1st: cols[tillIdx] || "",
              stops,
              deco: cols[decoIdx] || "",
              otu: cols[otuIdx] || "",
              esot: cols[esotIdx] || "",
              marker,
            });
          }
          return { rows, dvis5 };
        },

        parseSOX15CSV(text, targetDepth) {
          const lines = text.trim().split("\n");
          if (lines.length < 2) return { rows: [], dvis5: null };
          const rows = [];
          let dvis5 = null;
          let foundFirst = false;
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const cols = line.split(",").map((v) => v.trim());
            if (cols.length < 24) continue;
            const depth = parseInt(cols[5]);
            if (isNaN(depth) || depth !== targetDepth) continue;
            if (!foundFirst) {
              const dvisVal = parseInt(cols[3]);
              if (!isNaN(dvisVal)) dvis5 = dvisVal;
              foundFirst = true;
            }
            const time = parseInt(cols[6]);
            if (isNaN(time)) continue;
            const till1st = cols[7] || "";
            const stops = [];
            for (let j = 0; j < 12; j++) {
              const val = cols[8 + j];
              if (val === "") stops.push(null);
              else {
                const num = parseInt(val);
                stops.push(isNaN(num) ? null : num);
              }
            }
            let marker = 0;
            if (cols.length > 23) {
              const markerVal = parseInt(cols[23]);
              if (markerVal === 3) marker = 3;
            }
            rows.push({
              time,
              till1st,
              stops,
              deco: cols[20] || "",
              otu: cols[21] || "",
              esot: cols[22] || "",
              marker,
            });
          }
          return { rows, dvis5 };
        },

        parseSAB15CSV(text, targetDepth) {
          const lines = text.trim().split("\n");
          if (lines.length < 2) return { rows: [], dvis5: null };
          const rows = [];
          let dvis5 = null;
          let foundFirst = false;
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const cols = line.split(",").map((v) => v.trim());
            if (cols.length < 25) continue;
            const depth = parseInt(cols[7]);
            if (isNaN(depth) || depth !== targetDepth) continue;
            if (!foundFirst) {
              const dvisVal = parseInt(cols[3]);
              if (!isNaN(dvisVal)) dvis5 = dvisVal;
              foundFirst = true;
            }
            const time = parseInt(cols[8]);
            if (isNaN(time)) continue;
            const till1st = cols[9] || "";
            const stops = [];
            for (let j = 0; j < 11; j++) {
              const val = cols[10 + j];
              if (val === "") stops.push(null);
              else {
                const num = parseInt(val);
                stops.push(isNaN(num) ? null : num);
              }
            }
            let marker = 0;
            if (cols.length > 24) {
              const markerVal = parseInt(cols[24]);
              if (markerVal === 3) marker = 3;
            }
            rows.push({
              time,
              till1st,
              stops,
              deco: cols[21] || "",
              otu: cols[22] || "",
              esot: cols[23] || "",
              marker,
            });
          }
          return { rows, dvis5 };
        },

        parseNitroxCSV(text, targetDepth) {
          const lines = text.trim().split("\n");
          if (lines.length < 2) return { rows: [], dvis5: null };
          const rows = [];
          let dvis5 = null;
          let foundFirst = false;
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const cols = line.split(",").map((v) => v.trim());
            if (cols.length < 22) continue;
            const depth = parseInt(cols[7]);
            if (isNaN(depth) || depth !== targetDepth) continue;
            if (!foundFirst) {
              const dvisVal = parseInt(cols[3]);
              if (!isNaN(dvisVal)) dvis5 = dvisVal;
              foundFirst = true;
            }
            const time = parseInt(cols[8]);
            if (isNaN(time)) continue;
            const till1st = cols[9] || "";
            const stops = [];
            for (let j = 0; j < 8; j++) {
              const val = cols[10 + j];
              if (val === "") stops.push(null);
              else {
                const num = parseInt(val);
                stops.push(isNaN(num) ? null : num);
              }
            }
            let marker = 0;
            if (cols.length > 21) {
              const markerVal = parseInt(cols[21]);
              if (markerVal === 3) marker = 3;
            }
            rows.push({
              time,
              till1st,
              stops,
              deco: cols[18] || "",
              otu: cols[19] || "",
              esot: cols[20] || "",
              marker,
            });
          }
          return { rows, dvis5 };
        },

        parseBOX15CSV(text, targetDepth) {
          const lines = text.trim().split("\n");
          if (lines.length < 2) return { rows: [], dvis5: null };
          const rows = [];
          let dvis5 = null;
          let foundFirst = false;
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            const cols = line.split(",").map((v) => v.trim());
            if (cols.length < 23) continue;
            const depth = parseInt(cols[5]);
            if (isNaN(depth) || depth !== targetDepth) continue;
            if (!foundFirst) {
              const dvisVal = parseInt(cols[3]);
              if (!isNaN(dvisVal)) dvis5 = dvisVal;
              foundFirst = true;
            }
            const time = parseInt(cols[6]);
            if (isNaN(time)) continue;
            const till1st = cols[7] || "";
            const stops = [];
            for (let j = 0; j < 12; j++) {
              const val = cols[8 + j];
              if (val === "") stops.push(null);
              else {
                const num = parseInt(val);
                stops.push(isNaN(num) ? null : num);
              }
            }
            let marker = 0;
            if (cols.length > 20) {
              const markerVal = parseInt(cols[20]);
              if (markerVal === 1 || markerVal === 3) marker = markerVal;
            }
            rows.push({
              time,
              till1st,
              stops,
              deco: cols[20] || "",
              otu: cols[21] || "",
              esot: cols[22] || "",
              marker,
            });
          }
          return { rows, dvis5 };
        },

        getParserForTable(code) {
          if (code === "SIL15" || code === "H2SIL15" || code === "H4SIL15")
            return this.parseSIL15CSV.bind(this);
          if (code === "SOX15" || code === "HSOX15")
            return this.parseSOX15CSV.bind(this);
          if (code === "SAB15" || code === "HSAB15")
            return this.parseSAB15CSV.bind(this);
          if (code === "NIA15" || code === "H2NIA15" || code === "H4NIA15" || code === "NIB15" || code === "H2NIB15" || code === "H4NIB15")
            return this.parseNitroxCSV.bind(this);
          if (code === "BOX15")
            return this.parseBOX15CSV.bind(this);
          return this.parseSIL15CSV.bind(this);
        },

        renderLevel1() {
          let html = '<div class="grid">';
          this.groups.forEach((g, i) => {
            html += `<div class="card" onclick="app.renderLevel2(${i})">
                        <div class="tag ${g.tag}">${g.name}</div>
                        <p>${g.tables.length} table${g.tables.length !== 1 ? "s" : ""}</p>
                    </div>`;
          });
          document.getElementById("content").innerHTML = html + "</div>";
        },

        renderLevel2(gIdx) {
          const g = this.groups[gIdx];
          if (g.tables.length === 1) {
            this.renderLevel3(gIdx, 0);
            return;
          }
          let html = `<button class="back-btn" onclick="app.renderLevel1()">← Back</button><div class="grid">`;
          g.tables.forEach((t, tIdx) => {
            html += `<div class="card" onclick="app.renderLevel3(${gIdx}, ${tIdx})">
                        <div class="tag ${g.tag}">${g.name}</div>
                        <h3>${t.name}</h3>
                        <p>Code: ${t.code}</p>
                    </div>`;
          });
          document.getElementById("content").innerHTML = html + "</div>";
        },

        renderLevel3(gIdx, tIdx) {
          const g = this.groups[gIdx];
          const t = g.tables[tIdx];
          let html = `<button class="back-btn" onclick="app.renderLevel2(${gIdx})">← Back</button>`;
          html += `<div class="section"><h2>${t.name}</h2><p>Code: ${t.code}</p></div>`;
          if (t.isReference) {
            html += `<div class="depths-grid">
                      <button class="depth-btn" onclick="app.renderReferenceTable(${gIdx}, ${tIdx})">Show Table</button>
                    </div>`;
          } else {
            html += '<div class="depths-grid">';
            t.depths.forEach((d) => {
              html += `<button class="depth-btn" onclick="app.renderTable(${gIdx}, ${tIdx}, ${d})">${d}m</button>`;
            });
            html += "</div>";
          }
          document.getElementById("content").innerHTML = html;
        },

        renderReferenceTable(gIdx, tIdx) {
          const g = this.groups[gIdx];
          const t = g.tables[tIdx];
          let html = `<button class="back-btn" onclick="app.renderLevel3(${gIdx}, ${tIdx})">← Back</button>`;
          document.getElementById("content").innerHTML = html + '<div class="loading">Loading table...</div>';
          this.loadCSV(t.code).then((csv) => {
            if (!csv) {
              html += '<div class="error">Unable to load table data</div>';
              document.getElementById("content").innerHTML = html;
              return;
            }
            const rows = this.parseReferenceTableCSV(csv);
            let tableHtml = `<div class="table-wrapper"><div class="table-header"><h2>${t.name}</h2></div>`;
            tableHtml += '<div class="table-scroll"><table><thead><tr>';
            tableHtml += '<th>Depth (m)</th><th>8h Interval (min)</th><th>2h Interval (min)</th>';
            tableHtml += "</tr></thead><tbody>";
            rows.forEach((row) => {
              tableHtml += `<tr class="row-white">
                            <td><strong>${row.depth}</strong></td>
                            <td>${row.col1 !== null ? row.col1 : "—"}</td>
                            <td>${row.col2 !== null ? row.col2 : "—"}</td>
                        </tr>`;
            });
            tableHtml += "</tbody></table></div></div>";
            document.getElementById("content").innerHTML = html + tableHtml;
          });
        },

        async renderTable(gIdx, tIdx, depth) {
          const g = this.groups[gIdx];
          const t = g.tables[tIdx];
          let html = `<button class="back-btn" onclick="app.renderLevel3(${gIdx}, ${tIdx})">← Back</button>`;
          document.getElementById("content").innerHTML = html + '<div class="loading">Loading table...</div>';
          const csv = await this.loadCSV(t.code);
          if (!csv) {
            html += '<div class="error">Unable to load table data</div>';
            document.getElementById("content").innerHTML = html;
            return;
          }
          const parser = this.getParserForTable(t.code);
          const { rows, dvis5 } = parser(csv, depth);
          if (rows.length === 0) {
            html += '<div class="error">No data found for this depth</div>';
            document.getElementById("content").innerHTML = html;
            return;
          }
          const headerConfig = this.headers[t.code];
          const title = headerConfig ? headerConfig.title : `${t.name} - ${depth}m`;
          html += `<div class="table-wrapper"><div class="table-header">
                    <h2>${title}</h2>
                    ${dvis5 ? `<p>DVIS 5 Time Limit: ${dvis5} min</p>` : ""}
                  </div>`;
          html += '<div class="table-scroll"><table><thead>';
          if (headerConfig && headerConfig.stopCols1 && headerConfig.stopCols2) {
            html += '<tr>';
            html += `<th rowspan="2">Dive Time<br>(min)</th>`;
            html += `<th rowspan="2">Till 1st<br>Stop</th>`;
            html += `<th colspan="${headerConfig.stopCols1.length}">In Water Stops</th>`;
            html += `<th colspan="${headerConfig.stopCols2.length}">Stops in Deco</th>`;
            html += `<th rowspan="2">Tot. Deco<br>(min)</th><th rowspan="2">OTU</th><th rowspan="2">ESOT</th>`;
            html += '</tr><tr>';
            headerConfig.stopCols1.forEach(col => {
              html += `<th>${col}</th>`;
            });
            headerConfig.stopCols2.forEach(col => {
              html += `<th>${col}</th>`;
            });
            html += '</tr>';
          } else if (headerConfig && headerConfig.stopCols) {
            html += '<tr>';
            html += `<th>Dive Time<br>(min)</th>`;
            html += `<th>Till 1st<br>Stop</th>`;
            html += `<th colspan="${headerConfig.stopCols.length}">Stop Depth (metres)</th>`;
            html += `<th>Tot. Deco<br>(min)</th><th>OTU</th><th>ESOT</th>`;
            html += '</tr><tr><th></th><th></th>';
            headerConfig.stopCols.forEach(col => {
              html += `<th>${col}</th>`;
            });
            html += '<th></th><th></th><th></th></tr>';
          } else {
            html += '<tr><th>Time (min)</th><th>Till 1st Stop</th><th colspan="8">Stop Depth (m)</th><th>Deco Time</th><th>OTU</th><th>ESOT</th></tr>';
            html += '<tr><th></th><th></th><th>24m</th><th>21m</th><th>18m</th><th>15m</th><th>12m</th><th>9m</th><th>6m</th><th>3m</th><th></th><th></th><th></th></tr>';
          }
          html += '</thead><tbody>';
          rows.forEach((row) => {
            let cls = "row-white";
            if (row.marker === 3) cls = "row-red";
            html += `<tr class="${cls}"><td><strong>${row.time}</strong></td><td>${row.till1st}</td>`;
            const numStops = headerConfig ? headerConfig.numStops : 8;
            for (let j = 0; j < numStops; j++) {
              const val = row.stops[j];
              html += `<td>${val !== null ? val : "—"}</td>`;
            }
            html += `<td>${row.deco}</td><td>${row.otu}</td><td>${row.esot}</td></tr>`;
          });
          html += "</tbody></table></div></div>";
          document.getElementById("content").innerHTML = html;
        },
      };

      app.renderLevel1();
    </script>
  </body>
</html>
