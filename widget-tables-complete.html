<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DivePlan Tables Widget</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
        background: linear-gradient(135deg, #f0f4f8, #fff, #f0f4f8);
        color: #333;
      }
      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        margin-bottom: 30px;
      }
      h1 {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
      }
      .subtitle {
        color: #6b7280;
      }
      .back-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 20px;
        font-size: 14px;
      }
      .back-btn:hover {
        background: #2563eb;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
      }
      .card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 18px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .card:hover {
        border-color: #3b82f6;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .card h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
      }
      .card p {
        font-size: 13px;
        color: #6b7280;
        margin-bottom: 8px;
      }
      .tag {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .tag-blue {
        background: #dbeafe;
        color: #1e40af;
      }
      .tag-cyan {
        background: #cffafe;
        color: #0e7490;
      }
      .tag-orange {
        background: #fed7aa;
        color: #92400e;
      }
      .tag-yellow {
        background: #fef08a;
        color: #854d0e;
      }
      .tag-green {
        background: #dcfce7;
        color: #166534;
      }
      .tag-indigo {
        background: #e0e7ff;
        color: #312e81;
      }
      .tag-purple {
        background: #f3e8ff;
        color: #6b21a8;
      }
      .tag-red {
        background: #fee2e2;
        color: #991b1b;
      }
      .section {
        background: white;
        border-radius: 8px;
        padding: 18px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
      }
      .section h2 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
      }
      .section p {
        font-size: 13px;
        color: #6b7280;
      }
      .depths-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
        gap: 10px;
        margin-top: 16px;
      }
      .depth-btn {
        padding: 10px 8px;
        border: 2px solid #3b82f6;
        background: white;
        color: #3b82f6;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
        transition: all 0.2s;
      }
      .depth-btn:hover {
        background: #eff6ff;
      }
      .table-wrapper {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .table-header {
        background: linear-gradient(to bottom, #1d4ed8, #1e40af);
        color: white;
        padding: 16px;
      }
      .table-header h2 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 2px;
      }
      .table-header p {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.9);
        margin: 0;
      }
      .table-scroll {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }
      thead {
        background: linear-gradient(to bottom, #1d4ed8, #1e40af);
        color: white;
        position: sticky;
        top: 0;
      }
      th {
        padding: 8px 4px;
        text-align: center;
        border: 1px solid #0d47a1;
        font-weight: 600;
        font-size: 10px;
        line-height: 1.2;
      }
      td {
        padding: 8px 4px;
        text-align: center;
        border: 1px solid #e5e7eb;
      }
      .row-white {
        background: white;
      }
      .row-white:hover {
        background: #eff6ff;
      }
      .row-green {
        background: #f0fdf4;
      }
      .row-green:hover {
        background: #eff6ff;
      }
      .row-red {
        background: #fef2f2;
      }
      .row-red:hover {
        background: #fee2e2;
      }
      .error {
        background: #fee2e2;
        color: #991b1b;
        padding: 12px;
        border-radius: 6px;
        margin: 16px 0;
      }
      .loading {
        text-align: center;
        padding: 20px;
        color: #6b7280;
      }
      footer {
        text-align: center;
        padding: 20px;
        color: #9ca3af;
        font-size: 11px;
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Dive Tables</h1>
        <p class="subtitle">Browse decompression tables</p>
      </header>
      <div id="content"></div>
      <footer>DivePlan Tables Widget | Standalone</footer>
    </div>

    <script>
      const app = {
        groups: [
          {
            name: "No Stops Air",
            tag: "tag-blue",
            tables: [
              {
                name: "ND15",
                code: "ND15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
              {
                name: "LND15",
                code: "LND15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
            ],
          },
          {
            name: "Standard Air",
            tag: "tag-cyan",
            tables: [
              {
                name: "SIL15 12h",
                code: "SIL15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
              {
                name: "SIL15 2h",
                code: "H2SIL15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
              {
                name: "SIL15 4h",
                code: "H4SIL15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
            ],
          },
          {
            name: "SurO2",
            tag: "tag-orange",
            tables: [
              {
                name: "SOX15 12h",
                code: "SOX15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
              {
                name: "SOX15 4h",
                code: "HSOX15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
            ],
          },
          {
            name: "Backup Air",
            tag: "tag-yellow",
            tables: [
              {
                name: "SAB15 12h",
                code: "SAB15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
              {
                name: "SAB15 4h",
                code: "HSAB15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
            ],
          },
          {
            name: "Nitrox",
            tag: "tag-green",
            tables: [
              { name: "NIA 40% 12h", code: "NIA15", depths: [18, 21, 24, 27] },
              { name: "NIA 40% 2h", code: "H2NIA15", depths: [18, 21, 24, 27] },
              { name: "NIA 40% 4h", code: "H4NIA15", depths: [18, 21, 24, 27] },
              {
                name: "NIB 35% 12h",
                code: "NIB15",
                depths: [18, 21, 24, 27, 30, 33],
              },
              {
                name: "NIB 35% 2h",
                code: "H2NIB15",
                depths: [18, 21, 24, 27, 30, 33],
              },
              {
                name: "NIB 35% 4h",
                code: "H4NIB15",
                depths: [18, 21, 24, 27, 30, 33],
              },
            ],
          },
          {
            name: "Wet/Dry Bell",
            tag: "tag-indigo",
            tables: [
              {
                name: "BOX15",
                code: "BOX15",
                depths: [
                  12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51,
                ],
              },
            ],
          },
          {
            name: "Treatment",
            tag: "tag-red",
            tables: [
              {
                name: "Treatment Tables",
                code: "TREATMENT",
                depths: [],
                isImage: true,
              },
            ],
          },
        ],

        async loadCSV(code) {
          try {
            const response = await fetch(`/data/tables/${code}.csv`);
            if (!response.ok) return null;
            return await response.text();
          } catch (e) {
            console.error("CSV load failed:", e);
            return null;
          }
        },

        parseCSV(text, depth) {
          const lines = text.trim().split("\n");
          if (lines.length < 2) return { headers: [], rows: [] };
          const headers = lines[0].split(",").map((h) => h.trim());
          const depthIdx = headers.findIndex((h) => h.toLowerCase().includes("depth"));
          const rows = [];
          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(",").map((c) => c.trim());
            if (depthIdx >= 0 && parseInt(cols[depthIdx]) !== depth) continue;
            rows.push(cols);
          }
          return { headers, rows };
        },

        renderLevel1() {
          let html = '<div class="grid">';
          this.groups.forEach((g, i) => {
            html += `<div class="card" onclick="app.renderLevel2(${i})">
        <div class="tag ${g.tag}">${g.name}</div>
        <p>${g.tables.length} table${g.tables.length !== 1 ? "s" : ""}</p>
      </div>`;
          });
          document.getElementById("content").innerHTML = html + "</div>";
        },

        renderLevel2(gIdx) {
          const g = this.groups[gIdx];
          if (g.tables.length === 1) {
            this.renderLevel3(gIdx, 0);
            return;
          }
          let html = `<button class="back-btn" onclick="app.renderLevel1()">← Back</button><div class="grid">`;
          g.tables.forEach((t, tIdx) => {
            html += `<div class="card" onclick="app.renderLevel3(${gIdx}, ${tIdx})">
        <div class="tag ${g.tag}">${g.name}</div>
        <h3>${t.name}</h3>
        <p>${t.code}</p>
      </div>`;
          });
          document.getElementById("content").innerHTML = html + "</div>";
        },

        renderLevel3(gIdx, tIdx) {
          const g = this.groups[gIdx];
          const t = g.tables[tIdx];
          let html = `<button class="back-btn" onclick="app.renderLevel2(${gIdx})">← Back</button>`;
          html += `<div class="section"><h2>${t.name}</h2><p>${t.code}</p></div>`;
          if (t.isImage) {
            html += `<div class="table-wrapper"><div class="table-header"><h2>Treatment Table</h2></div>
        <div style="padding:20px;text-align:center;color:#666">Treatment tables (image-based)</div></div>`;
          } else {
            html += '<div class="depths-grid">';
            t.depths.forEach((d) => {
              html += `<button class="depth-btn" onclick="app.renderTable(${gIdx}, ${tIdx}, ${d})">${d}m</button>`;
            });
            html += "</div>";
          }
          document.getElementById("content").innerHTML = html;
        },

        async renderTable(gIdx, tIdx, depth) {
          const g = this.groups[gIdx];
          const t = g.tables[tIdx];
          let html = `<button class="back-btn" onclick="app.renderLevel3(${gIdx}, ${tIdx})">← Back</button>`;
          document.getElementById("content").innerHTML =
            html + '<div class="loading">Loading...</div>';
          const csv = await this.loadCSV(t.code);
          if (!csv) {
            document.getElementById("content").innerHTML =
              html + '<div class="error">No data available</div>';
            return;
          }
          const parsed = this.parseCSV(csv, depth);
          if (!parsed.rows.length) {
            document.getElementById("content").innerHTML =
              html +
              '<div class="error">No data for depth ' +
              depth +
              "m</div>";
            return;
          }
          html += `<div class="table-wrapper"><div class="table-header"><h2>${t.name} - ${depth}m</h2></div>`;
          html += '<div class="table-scroll"><table><thead><tr>';
          parsed.headers.forEach((h) => {
            html += `<th>${h}</th>`;
          });
          html += "</tr></thead><tbody>";
          parsed.rows.forEach((row, idx) => {
            const cls = idx % 2 === 0 ? "row-white" : "row-green";
            html += "<tr class=\"" + cls + "\">";
            row.forEach((cell) => {
              html += `<td>${cell}</td>`;
            });
            html += "</tr>";
          });
          html += "</tbody></table></div></div>";
          document.getElementById("content").innerHTML = html;
        },
      };

      app.renderLevel1();
    </script>
  </body>
</html>
