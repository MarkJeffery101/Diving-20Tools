<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DivePlan Tables</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
        background: linear-gradient(135deg, #f0f4f8, #fff, #f0f4f8);
        color: #333;
      }
      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        margin-bottom: 30px;
      }
      h1 {
        font-size: 32px;
        font-weight: 700;
        color: #1f2937;
      }
      .subtitle {
        color: #6b7280;
      }
      .back-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .back-btn:hover {
        background: #2563eb;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }
      .card {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 18px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .card:hover {
        border-color: #3b82f6;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }
      .card h3 {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
      }
      .card p {
        font-size: 13px;
        color: #6b7280;
      }
      .card .tag {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        margin-bottom: 10px;
      }
      .tag-blue {
        background: #dbeafe;
        color: #1e40af;
      }
      .tag-cyan {
        background: #cffafe;
        color: #0e7490;
      }
      .tag-orange {
        background: #fed7aa;
        color: #92400e;
      }
      .tag-yellow {
        background: #fef08a;
        color: #854d0e;
      }
      .tag-green {
        background: #dcfce7;
        color: #166534;
      }
      .tag-indigo {
        background: #e0e7ff;
        color: #312e81;
      }
      .section {
        background: white;
        border-radius: 8px;
        padding: 18px;
        margin-bottom: 16px;
        border: 1px solid #e5e7eb;
      }
      .section h2 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
      }
      .depths-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        margin-top: 16px;
      }
      .depth-btn {
        padding: 12px;
        border: 2px solid #3b82f6;
        background: white;
        color: #3b82f6;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .depth-btn:hover {
        background: #eff6ff;
      }
      .table-wrapper {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .table-header {
        background: linear-gradient(to bottom, #1d4ed8, #1e40af);
        color: white;
        padding: 16px;
      }
      .table-header h2 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 2px;
      }
      .table-scroll {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      thead {
        background: linear-gradient(to bottom, #1d4ed8, #1e40af);
        color: white;
        position: sticky;
        top: 0;
      }
      th {
        padding: 10px 6px;
        text-align: center;
        border: 1px solid #0d47a1;
        font-weight: 600;
        font-size: 11px;
      }
      td {
        padding: 10px 6px;
        text-align: center;
        border: 1px solid #e5e7eb;
      }
      .row-white {
        background: white;
      }
      .row-white:hover {
        background: #eff6ff;
      }
      .row-green {
        background: #f0fdf4;
      }
      .row-green:hover {
        background: #eff6ff;
      }
      .row-red {
        background: #fef2f2;
      }
      .row-red:hover {
        background: #fee2e2;
      }
      .marker-2 {
        border-bottom: 3px solid #1f2937 !important;
      }
      footer {
        text-align: center;
        padding: 20px;
        color: #9ca3af;
        font-size: 12px;
        margin-top: 40px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Dive Tables</h1>
        <p class="subtitle">Browse decompression tables</p>
      </header>
      <div id="content"></div>
      <footer>DivePlan Tables Widget | Offline ready</footer>
    </div>

    <script>
      const app = {
        tables: [
          { cat: "No-Stop", tag: "tag-blue", name: "No-Stop Limits Air", code: "ND15", depths: [9,12,15,18,21,24,27,30,33,36] },
          { cat: "No-Stop", tag: "tag-blue", name: "No-Stop Limits Extended", code: "LND15", depths: [9,12,15,18,21,24,27,30,33,36] },
          { cat: "Air", tag: "tag-cyan", name: "Standard Air 12h", code: "SIL15", depths: [12,15,18,21,24,27,30,33,36,39,42,45,48,51] },
          { cat: "Air", tag: "tag-cyan", name: "Standard Air 2h", code: "H2SIL15", depths: [12,15,18,21,24,27,30,33,36,39,42,45,48,51] },
          { cat: "Air", tag: "tag-cyan", name: "Standard Air 4h", code: "H4SIL15", depths: [12,15,18,21,24,27,30,33,36,39,42,45,48,51] },
          { cat: "O2", tag: "tag-orange", name: "Surface O2 12h", code: "SOX15", depths: [12,15,18,21,24,27,30,33,36,39,42,45,48,51] },
          { cat: "O2", tag: "tag-orange", name: "Surface O2 4h", code: "HSOX15", depths: [12,15,18,21,24,27,30,33,36,39,42,45,48,51] },
          { cat: "Backup", tag: "tag-yellow", name: "Backup Air 12h", code: "SAB15", depths: [12,15,18,21,24,27,30,33,36,39,42,45,48,51] },
          { cat: "Backup", tag: "tag-yellow", name: "Backup Air 4h", code: "HSAB15", depths: [12,15,18,21,24,27,30,33,36,39,42,45,48,51] },
          { cat: "Nitrox", tag: "tag-green", name: "NIA 40% 12h", code: "NIA15", depths: [18,21,24,27] },
          { cat: "Nitrox", tag: "tag-green", name: "NIA 40% 2h", code: "H2NIA15", depths: [18,21,24,27] },
          { cat: "Nitrox", tag: "tag-green", name: "NIA 40% 4h", code: "H4NIA15", depths: [18,21,24,27] },
          { cat: "Nitrox", tag: "tag-green", name: "NIB 35% 12h", code: "NIB15", depths: [18,21,24,27,30,33] },
          { cat: "Nitrox", tag: "tag-green", name: "NIB 35% 2h", code: "H2NIB15", depths: [18,21,24,27,30,33] },
          { cat: "Nitrox", tag: "tag-green", name: "NIB 35% 4h", code: "H4NIB15", depths: [18,21,24,27,30,33] },
          { cat: "Box", tag: "tag-indigo", name: "Box Air/O2", code: "BOX15", depths: [12,15,18,21,24,27,30,33,36,39,42,45,48,51] },
        ],

        csvCache: {},

        parseCSV(text, code, wantedDepth) {
          const lines = text.trim().split("\n");
          if (lines.length < 2) return [];

          // Special handling for reference tables (ND15, LND15)
          if (code === 'ND15' || code === 'LND15') {
            return this.parseReferenceTable(text);
          }

          const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
          const rows = [];

          // Find column indices dynamically (same as React code)
          const depthIndex = headers.findIndex(h => h.includes('depth') && !h.includes('deco') && !h.includes('stop'));
          const timeIndex = headers.findIndex(h => h.includes('dive') && h.includes('time'));
          const tillIndex = headers.findIndex(h => h.includes('till') || h.includes('1st'));
          const decoIndex = headers.findIndex(h => h.includes('deco') && h.includes('time'));
          const otuIndex = headers.findIndex(h => h.includes('otu'));
          const esotIndex = headers.findIndex(h => h.includes('esot'));
          const markerIndex = esotIndex + 1;
          const stopStart = tillIndex + 1;
          const stopEnd = decoIndex;

          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const cols = line.split(",").map(v => v.trim());
            const depth = parseInt(cols[depthIndex]);
            if (isNaN(depth) || depth !== wantedDepth) continue;

            const time = parseInt(cols[timeIndex]);
            if (isNaN(time)) continue;

            const stops = [];
            for (let j = stopStart; j < stopEnd && j < cols.length; j++) {
              const val = cols[j];
              stops.push(val === "" ? null : parseInt(val) || null);
            }

            rows.push({
              time,
              till1st: cols[tillIndex],
              stops,
              deco: cols[decoIndex] || "",
              otu: cols[otuIndex] || "",
              esot: cols[esotIndex] || "",
              marker: parseInt(cols[markerIndex]) || 0,
            });
          }

          return rows;
        },

        parseReferenceTable(text) {
          const lines = text.trim().split("\n");
          const rows = [];

          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const cols = line.split(",").map(v => v.trim());
            const depth = parseInt(cols[0]);
            if (isNaN(depth)) continue;

            const val1 = cols[1] || "";
            const val2 = cols[2] || "";

            rows.push({
              time: depth,
              till1st: val1,
              stops: [parseInt(val1) || null, parseInt(val2) || null, null, null, null, null, null, null],
              deco: "",
              otu: "",
              esot: "",
              marker: 0,
            });
          }

          return rows;
        },

        async loadCSV(code) {
          if (this.csvCache[code]) return this.csvCache[code];

          try {
            const response = await fetch(`/data/tables/${code}.csv`);
            if (!response.ok) return "";
            const text = await response.text();
            this.csvCache[code] = text;
            return text;
          } catch (e) {
            console.error("CSV load error:", e);
            return "";
          }
        },

        renderLevel1() {
          let html = '<div class="grid">';
          this.tables.forEach((t, i) => {
            html += `<div class="card" onclick="app.renderLevel2(${i})">
                        <div class="tag ${t.tag}">${t.cat}</div>
                        <h3>${t.name}</h3>
                        <p>${t.code}</p>
                    </div>`;
          });
          document.getElementById("content").innerHTML = html + "</div>";
        },

        renderLevel2(idx) {
          const t = this.tables[idx];
          let html = `<button class="back-btn" onclick="app.renderLevel1()">← Back</button>`;
          html += `<div class="section"><h2>${t.name}</h2><p>Code: ${t.code}</p></div>`;
          html += '<div class="depths-grid">';
          t.depths.forEach((d) => {
            html += `<button class="depth-btn" onclick="app.renderTable(${idx}, ${d})">${d}m</button>`;
          });
          document.getElementById("content").innerHTML = html + "</div>";
        },

        async renderTable(idx, depth) {
          const t = this.tables[idx];
          let html = `<button class="back-btn" onclick="app.renderLevel2(${idx})">← Back</button>`;

          const csv = await this.loadCSV(t.code);
          if (!csv) {
            html += "<p>Unable to load table data</p>";
            document.getElementById("content").innerHTML = html;
            return;
          }

          const rows = this.parseCSV(csv, t.code, depth);

          html += `<div class="table-wrapper"><div class="table-header"><h2>${t.name} - ${depth}m</h2></div>`;
          html +=
            '<div class="table-scroll"><table><thead><tr><th>Dive Time<br>(min)</th><th>Till 1st<br>Stop</th><th colspan="8">Stop Depth (metres)</th><th>Deco</th><th>OTU</th><th>ESOT</th></tr>';
          html +=
            "<tr><th></th><th></th><th>24m</th><th>21m</th><th>18m</th><th>15m</th><th>12m</th><th>9m</th><th>6m</th><th>3m</th><th></th><th></th><th></th></tr></thead><tbody>";

          rows.forEach((row, i) => {
            const isLast = i === rows.length - 1;
            let cls = isLast
              ? "row-red"
              : i % 2 === 0
                ? "row-white"
                : "row-green";
            if (row.marker === 2) cls += " marker-2";

            html += `<tr class="${cls}"><td><strong>${row.time}</strong></td><td>${row.till1st}</td>`;
            for (let j = 0; j < 8; j++) {
              const val = row.stops[j];
              html += `<td>${val !== null ? val : "—"}</td>`;
            }
            html += `<td>${row.deco}</td><td>${row.otu}</td><td>${row.esot}</td></tr>`;
          });

          html += "</tbody></table></div></div>";
          document.getElementById("content").innerHTML = html;
        },
      };

      app.renderLevel1();
    </script>
  </body>
</html>
